# 力位混合控制

只支持SDK V1.11.0以上版本，算法原理可关注先楫KB获取。

## 概述

**hybrid_force_position** 工程展示了直流无刷电机的力位混合控制。

- 电机控制算法为 **FOC**（磁场定向控制）
- 实现基于 PD 控制器的力位混合控制
- 支持硬件和软件两种电流环实现方式
- 支持 ABZ 编码器位置检测方式
- 具备速度滤波和力矩限制功能

## 主要特性

### 混合控制算法
- **位置控制**：采用可配置 kp 和 kd 增益的 PD 控制器
- **力控制**：可调节限制的力矩输出
- **速度滤波**：带死区的低通滤波器以减少噪声
- **柔顺控制**：结合位置刚度和力反馈

### 控制参数
- `kp`：位置比例增益（默认：0.06）
- `kd`：速度阻尼增益（默认：0.001429）
- `tau_limit`：力矩输出限制（默认：±0.5 Nm）
- `speed_lpf_alpha`：速度滤波系数（默认：0.003）
- `speed_deadzone`：速度滤波死区（默认：0.1 rad/s）

## 硬件配置

### 电机规格
本例程使用的是雷赛智能的 **BLM57050-1000** 无刷电机，电机具体参数请参考[雷赛智能官网](https://leisai.com/)。

### 板子设置
板子设置参考开发板文档 :ref:`Motor Pin <board_resource>` 相关内容：

- 确保 PWM 频率设置正确（默认：20kHz）
- 确保电机极对数设置正确
- 确保 ADC 采样配置正确

### 外设配置说明

#### PWM 配置
- 使用 BLDC PWM 模块
- 配置死区时间，防止上下管直通
- 配置互补 PWM 输出
- 支持三相六路 PWM 输出
- 支持 PWM 同步触发 ADC 采样
- 使用影子寄存器更新 PWM 占空比
- 支持 PWM 故障保护功能

#### ADC 配置
- 使用两个 ADC 模块分别采样 U 相和 V 相电流
- 配置 ADC 参考电压（3.3V）
- 配置运放增益（10倍）
- 配置采样精度（12位）
- 支持 DMA 传输
- 支持 ADC 同步采样
- 支持 ADC 采样触发源配置
- 支持 ADC 采样中断

#### 编码器配置
- 支持 ABZ 编码器和 QEI 编码器
- 配置编码器精度
- 配置编码器方向
- 配置编码器采样周期
- 支持编码器位置计数
- 支持编码器速度计算

#### 定时器配置
- 使用 GPTMR 作为定时器
- 配置电流环采样周期（50us）
- 配置速度环采样周期（250us）
- 配置位置环采样周期（1ms）
- 支持定时器中断

## 电流环性能

硬件电流环显示接近零的计算时间。软件电流环计算时间在 1us 左右，这个时间会根据角度不同而波动，波动范围在 25%。

测量电流环时间的方法：
- 在 `mcl_app_config.h` 中仅开启 `MCL_EN_LOOP_TIME_COUNT` 宏
- 使用 `flash_xip_release` 编译选项

## 运行演示

### 初始化序列

1. 电机上电后执行对中动作
2. 系统初始化混合控制参数
3. 电机进入力位混合控制模式
4. 控制台显示当前控制参数

### 用户输入

可以通过串口控制台输入目标位置来控制电机：

**位置输入**：整数值，单位为度
- 范围：实际范围取决于应用需求
- 单位：度
- 正值：顺时针方向
- 负值：逆时针方向

### 控制台输出

```console
Hybrid force-position control mode.

Hybrid control mode
kp=0.060, kd=0.001, tau_limit=0.500
Speed filter: alpha=0.003, deadzone=0.10 rad/s
Target position: 0 degrees
Input position:
90
Pos: 90 deg, Tau: 0.1234 Nm, Pos_err: 0.0123, Speed: 0.234 rad/s
Input position:
-45
Pos: -45 deg, Tau: -0.0987 Nm, Pos_err: -0.0087, Speed: -0.156 rad/s
Input position:
```

### 状态信息

对于每个位置命令，系统显示：
- **Pos**：目标位置（度）
- **Tau**：输出力矩（牛顿·米）
- **Pos_err**：位置误差（弧度）
- **Speed**：当前角速度（rad/s）

## 安全警告

- **对中阶段**：电机上电后首先要完成对中动作，这时候请不要干预电机运行，否则会产生抖动
- **电流监测**：电机运行时，请时刻注意电流大小，如果发生异常，请随时准备切断电源
- **输入格式**：输入位置数值后，需要按回车键确认输入
- **初次测试**：首次运行时，建议从小幅度位置变化开始测试
- **力反馈**：混合控制器允许柔顺运动 - 电机会根据配置的刚度和阻尼参数响应外力

## 应用说明

### 调参指南

1. **增加刚度**：增大 `kp` 值可获得更强的位置保持能力
2. **增加阻尼**：增大 `kd` 值可减少振荡
3. **调节柔顺性**：降低 `kp` 和 `kd` 值可获得更柔顺的行为
4. **力矩限制**：根据应用安全需求调整 `tau_limit`
5. **噪声抑制**：调节 `speed_lpf_alpha` 和 `speed_deadzone` 以过滤传感器噪声

### 典型应用

- 协作机器人（cobots）
- 触觉反馈设备
- 带力控制的精密装配
- 受限环境中的柔顺运动
- 人机交互场景

## 完成配置

完成上述配置后：
1. 给驱动板上电，观察电流无异常
2. 给核心板上电，再次确认电流无异常
3. 烧录程序，观察运行现象

